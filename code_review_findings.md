
| File Path | Line Number | Description of the Issue | Severity Level |
| :--- | :--- | :--- | :--- |
| `src/mbe_automation/ml/delta.py` | 215 | The regression target `E_delta` is calculated as `E_target - sum(n * E_atomic_baseline)`. This assumes the baseline energy of the *structure* is simply the sum of atomic baseline energies, which ignores baseline interactions. The correct Delta Learning target is usually `E_target - E_baseline_total`. | Critical |
| `src/mbe_automation/ml/delta.py` | 179-183 | The `_energy_shifts_average` function assigns a uniform shift `E_delta` to *all* elements (`np.full(stats.n_elements, fill_value=E_delta)`). This shift is `mean(E_target) - mean(E_baseline)`. This implies every atom type contributes equally to the total energy difference, regardless of element type or stoichiometry, which is physically unrealistic for multi-component systems. | Critical |
| `src/mbe_automation/ml/descriptors/mace.py` | 84-85 | `atomic_hdf5` uses HDF5 keys `'positions'` and `'cells'` (lines 71, 79), but `src/mbe_automation/storage/core.py` (lines 485, 497) saves them as `'positions (Å)'` and `'cell_vectors (Å)'`. This will cause a `KeyError` at runtime. | Critical |
| `src/mbe_automation/ml/delta.py` | 388-390 | In `export_to_mace`, when `reference_energy_type` is `"reference_molecule"`, `Delta_E_pot` is adjusted by subtracting `Delta_E_pot_molecule`. This subtracts a scalar (representing one molecule's delta) from the total structure delta. If the structure is a crystal containing Z molecules, this fails to scale the subtraction by Z (it should subtract `Z * Delta_E_pot_molecule`), leading to incorrect training targets for Z > 1. | Critical |
| `src/mbe_automation/ml/delta.py` | 338, 364-384 | `E_atomic_shifts` is initialized to zeros when `reference_energy_type` is `"reference_molecule"`. The subsequent code (lines 364-384) iterates and exports "IsolatedAtom" entries with these 0-value shifts. This creates training data asserting that isolated atoms have 0 energy shift, which may be unintended if the user expects atomic shifts to be meaningful relative to free atoms. | Major |
| `src/mbe_automation/ml/delta.py` | 260-264 | `_energy_shifts` requires `reference_molecule` if `reference_energy_type` is `"reference_molecule"`, but the argument type hint allows `None`. While a `ValueError` is raised, the type safety is weakened. | Minor |
| `src/mbe_automation/ml/delta.py` | 230 | `np.linalg.lstsq(A, b, rcond=None)`: Usage of `rcond=None` is discouraged and may lead to future warnings or inconsistent behavior across numpy versions. | Minor |

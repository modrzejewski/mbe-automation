# Review of New Features in `machine-learning` Branch

## 1. Executive Summary

The `machine-learning` branch introduces a more robust and systematic HDF5 storage format. The primary feature is the addition of a `dataclass` attribute to HDF5 groups, enabling the system to identify the type of object stored (e.g., `Structure`, `ForceConstants`, `MolecularCrystal`). This change improves data retrieval and enables generic inspection tools.

However, this update includes **breaking changes** to the HDF5 file path structure for phonon-related data and structures. Old datasets will not be compatible with the new code, and scripts relying on the old paths will fail. Additionally, inconsistencies between the new code, configuration defaults, and documentation were identified.

## 2. Findings

| File Path | Line Number | Description of the Issue | Severity Level |
| :--- | :--- | :--- | :--- |
| `src/mbe_automation/dynamics/harmonic/data.py` | 228 | **Breaking Change**: The HDF5 key path for force constants has changed from `.../phonons/{label}/force_constants` to `.../phonons/force_constants/{label}`. This breaks backward compatibility with existing datasets. | High |
| `src/mbe_automation/dynamics/harmonic/data.py` | 234 | **Breaking Change**: The HDF5 key path for Brillouin zone paths has changed from `.../phonons/{label}/brillouin_zone_path` to `.../phonons/brillouin_zone_paths/{label}`. | High |
| `src/mbe_automation/dynamics/harmonic/data.py` | 244 | **Breaking Change**: The HDF5 key path for relaxed structures has changed from `.../relaxation/{label}` to `.../structures/{label}`. | High |
| `src/mbe_automation/configs/training.py` | 17 | **Configuration Mismatch**: The default value for `force_constants_key` in `PhononSampling` points to the old path location (`.../phonons/crystal.../force_constants`). The code now writes to `.../phonons/force_constants/crystal...`. This will cause the default configuration to fail when reading data generated by the new code. | High |
| `docs/03_training_set.md` | Table: `PhononSampling` Class | **Documentation Mismatch**: The documentation for `force_constants_key` default value reflects the old path structure, which is now incorrect. | Medium |
| `src/mbe_automation/storage/core.py` | 698 | **Ambiguous Dataclass**: The `dataclass` attribute for `save_trajectory` is set to `"Trajectory|Structure"`. This dual type might be confusing for automated readers. If it is meant to indicate inheritance, a cleaner approach might be preferred, or simply `"Trajectory"`. | Low |

## 3. Analysis of New Features

### Systematic HDF5 Storage
**Utility:** The addition of `dataclass` attributes to HDF5 groups is a significant improvement for data management. It allows generic reader functions to determine the class type of a stored object without prior knowledge, facilitating the creation of universal data inspection tools and improving type safety.

**Implementation:**
- `src/mbe_automation/storage/core.py` was updated to write `group.attrs["dataclass"] = "ClassName"` for all major data types (`BrillouinZonePath`, `EOSCurves`, `Structure`, `Trajectory`, `ForceConstants`, `MolecularCrystal`, `FiniteSubsystem`, `UniqueClusters`).

### Path Reorganization
**Utility:** Grouping similar data types under common roots (e.g., all force constants under `phonons/force_constants/`) improves the logical organization of the HDF5 file, making it easier to browse and less prone to naming collisions between system labels and data types.

**Implementation:**
- Paths were updated in `dynamics/harmonic/core.py`, `dynamics/harmonic/data.py`, and `workflows/quasi_harmonic.py`.
- **Note:** This reorganization is the source of the breaking changes and configuration mismatches listed above.

## 4. Recommendations

1.  **Fix Configuration Defaults:** Update `src/mbe_automation/configs/training.py` so that `PhononSampling.force_constants_key` defaults to the new path format: `"training/quasi_harmonic/phonons/force_constants/crystal[opt:atoms,shape]"`.
2.  **Update Documentation:** Reflect the new default path in `docs/03_training_set.md`.
3.  **Migration Path:** Consider adding a migration script or a "legacy read" mode if backward compatibility with old HDF5 files is important for users.
4.  **Standardize Dataclass Attribute:** For `Trajectory`, consider using just `"Trajectory"` if it is a strict subclass, or document the `"Trajectory|Structure"` notation if it implies polymorphism support in readers.
